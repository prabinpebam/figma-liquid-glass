<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Liquid Glass</title>
  <style>
    body {
      background-color: #f0f0f0;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }

    h1 {
      color: #333;
    }

    .button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 5px;
    }

    .input {
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
    }

    #output-area {
      margin-top: 12px;
      padding: 10px;
      border: 2px dashed #007bff;
      background: #fff;
      text-align: center;
    }

    #output-img {
      max-width: 100%;
      display: none;
    }
  </style>
</head>
<body>
  <h1>Liquid Glass</h1>

  <!-- effect selector -->
  <fieldset>
    <legend>Effect</legend>
    <label><input type="radio" name="fx" value="none"   id="fx-none"   /> None</label><br>
    <label><input type="radio" name="fx" value="liquid" id="fx-liquid"/> Liquid glass</label><br>
    <label><input type="radio" name="fx" value="invert" id="fx-invert" checked/> Invert</label>
  </fieldset>

  <button class="button" id="capture-btn">Capture image</button>

  <div id="output-area">
    <em id="placeholder">Captured image will appear here…</em>
    <img id="output-img" />
  </div>

  <!-- inline script -->
  <script>
    const OFFSET = 20;
    const send   = (t,p)=>parent.postMessage({pluginMessage:{type:t,...p}},'*');
    const log    = m=>send('ui-log',{payload:m});

    /* radio change → notify plugin */
    document.querySelectorAll('input[name="fx"]').forEach(i=>{
      i.addEventListener('change',e=>{
        if(i.checked) send('effect-change',{effect:i.value});
      });
    });

    /* capture btn */
    document.getElementById('capture-btn').onclick=()=>send('capture-image');

    /* receive slice */
    window.onmessage=e=>{
      const msg=e.data.pluginMessage;
      if(!msg||msg.type!=='image-captured'||msg.error)return;
      const effect=document.querySelector('input[name="fx"]:checked')?.value;
      if(effect!=='invert')return; // only process for invert now
      cropAndInvert(msg.data).then(url=>{
        const img=document.getElementById('output-img');
        img.src=url; img.style.display='block';
        document.getElementById('placeholder')?.remove();
        send('apply-image-fill',{data:url});
      });
    };

    function cropAndInvert(dataURL){
      return new Promise(res=>{
        const i=new Image();i.onload=()=>{
          const w=i.width-OFFSET*2,h=i.height-OFFSET*2,
                c=document.createElement('canvas');c.width=w;c.height=h,
                x=c.getContext('2d');
          x.drawImage(i,OFFSET,OFFSET,w,h,0,0,w,h);
          const id=x.getImageData(0,0,w,h),d=id.data;
          for(let p=0;p<d.length;p+=4){d[p]=255-d[p];d[p+1]=255-d[p+1];d[p+2]=255-d[p+2];}
          x.putImageData(id,0,0);res(c.toDataURL('image/png'));
        };i.src=dataURL;
      });
    }
  </script>
 </body>
 </html>